#!/bin/bash
conda activate env_ML
# Configuration - Edit these parameters directly in the script
DATA_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/data/UDEEP_minmax_filtered"
RUN_NAME="UDEEP_minmax"
OUTPUT_PATH="../../saved/lc_labels/$RUN_NAME"

# List of diaObjectIds to process - Leave empty to process all from dataset
DIA_OBJECT_IDS=(
3495809259583582208
3495901618560344064
3495906016606838787
3495892822467315717
3496055550188214296
3495906016606835742
3496086336513797153
3496015967769644066
3495963191211497507
3495954395118512164
3496068744327762982
3496059948234726439
3495971987304526890
3495853240048707626
3496055550188253230
3496046754095204400
3495971987304549426
3495826851769657398
3495963191211501629
3495888424420857919
3495826851769646143
3495853240048708674
3495949997071961155
3496143511118433352
3496024763862630474
3495914812699912270
3495971987304539225
3495945599025453146
3496007171676587106
3495949997071963237
3495936802932415595
3495888424420878447
3496029161909199984
3495914812699915377
3495954395118508150
3495879628327753849
3495901618560343162
3496068744327781508
3496002773630102662
3495971987304515719
3496007171676599432
3496011569723115655
3495888424420843659
3495963191211518092
3496051152141716619
3495989579490561167
3496086336513796240
3495857638095214736
3495884026374288530
3495866434188250258
3496051152141690007
3496134715025407129
3496015967769630882
3495941200978915492
3495866434188254382
3496046754095208634
3495897220513822906
3496103928699858106
3496002773630095546
3496020365816150213
3496051152141716680
3495976385351021770
3495892822467310803
3496103928699856084
3495976385351006424
3495963191211497700
3495980783397533926
3495892822467326191
3495936802932405490
3495884026374265078
3495906016606843127
3496020365816133885
3496024763862652160
3496068744327744772
3495971987304542468
3495897220513804550
3495963191211507975
3495963191211514120
3496051152141721862
3495884026374271247
3496051152141732115
3496033559955739927
3496130316978894109
3495862036141739297
3496015967769629995
3495971987304536364
3496042356048675117
3496051152141698352
3496090734560320819
3495870832234780981
3496029161909200182
3495928006839409974
3495822453723141439
3495967589258003776
3496020365816144191
3495870832234760513
3495923608792938831
3496103928699848016
3495971987304557905
3495892822467332434
3496024763862650196
3496055550188214622
3495910414653366626
3496046754095204711
3496029161909182824
3495971987304543597
3496011569723121005
3496015967769625967
3495892822467309941
3496108326746372470
3496007171676605819
3495818055676610941
3495914812699905409
3495993977537091974
3495906016606828935
3496033559955712391
3495963191211494801
3496139113071918483
3495980783397541273
3495862036141742493
3496059948234728863
3495949997071964576
3495976385351021986
3495928006839402923
3495932404885911983
3496055550188274098
3496134715025406388
3495985181444047294
3495853240048702912
3495928006839386562
3496139113071916484
3496051152141714885
3495897220513797583
3496090734560307666
3496029161909182931
3495932404885920212
3496059948234727897
3496143511118441948
3495813657630113244
3496139113071918559
3496143511118432745
3496033559955705327
3496011569723113981
3495831249816151551
3495831249816138241
3495923608792922627
3496143511118433796
3496059948234741254
3496024763862659593
3496086336513796621
3496046754095214099
3495897220513823252
3495923608792950297
3495976385351016986
3495963191211496988
3496007171676610077
3495971987304537630
3495936802932404765
3496033559955712540
3495945599025463841
3495941200978929189
3495971987304528432
3495862036141719089
3496064346281236017
3496068744327735859
3496064346281236023
3496011569723114041
3496002773630100032
3496007171676605003
3496073142374290001
3495954395118467670
3496059948234730075
3495967589258007138
3495862036141744739
3496051152141696611
3496029161909203564
3495862036141734508
3495866434188265070
3495892822467336815
3496064346281244278
3496007171676622461
3495844443955670656
3495989579490566792
3496042356048707213
3496095132606814862
3496059948234704526
3496051152141706900
3495980783397542551
3496099530653322906
3495989579490550426
3495818055676618398
3495980783397541535
3495936802932422312
3496029161909165741
3496007171676616368
3496051152141715121
3495989579490557619
3496068744327769785
3496051152141716162
3496055550188243654
3496002773630107335
3496007171676607177
3496051152141711050
3495985181444042443
3496099530653326026
3495862036141704911
3496068744327779024
3495910414653351631
3496064346281248474
3495914812699920091
3495993977537046243
3496024763862652643
3495897220513822437
3496033559955713772
3495949997071956718
3496073142374291183
3496011569723122415
3495949997071929073
3495892822467320562
3495813657630093050
3495949997071972098
3496029161909199624
3495967589258013448
3495914812699926287
3495936802932420368
3496103928699851537
3496007171676607251
3496007171676603168
3496099530653305638
3496029161909218091
3495901618560325425
3495888424420859704
3495949997071962936
3496086336513793850
3496020365816150850
3495853240048704323
3496086336513793860
3495822453723139911
3496011569723124553
3495936802932422478
3495954395118494544
3495941200978906966
3495870832234753880
3495923608792947546
3495822453723132763
3495848842002209632
3495822453723148131
3495976385351024488
3495976385350994797
3495954395118525296
3495976385351027570
3495945599025477491
3496011569723114355
3496046754095202173
3496064346281240446
3496090734560283519
3495976385351030657
3495976385351016326
3495941200978940809
3496103928699852685
3495888424420908942
3496011569723114382
3496002773630062496
3495862036141731745
3495897220513822626
3495945599025474472
3495989579490565050
3495989579490564029
3496059948234717125
3495949997071930309
3495985181444044743
3495866434188253125
3495928006839409614
3495866434188263382
3495923608792933337
3495967589258009570
3496086336513789930
3495963191211467756
3495967589258005494
3495928006839403511
)

# Allow command line arguments to override the defaults
if [ $# -ge 2 ]; then
    DATA_PATH="$1"
    OUTPUT_PATH="$2"
    shift 2
    if [ $# -gt 0 ]; then
        DIA_OBJECT_IDS=("$@")
    fi
fi

echo "Submitting lc_labels visualization batch job..."
echo "Data path: $DATA_PATH"
echo "Weights path: $WEIGHTS_PATH"
echo "Output path: $OUTPUT_PATH"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Convert OUTPUT_PATH to absolute path if it's relative
if [[ "$OUTPUT_PATH" == ../* ]]; then
    OUTPUT_PATH="$PROJECT_ROOT/$(echo "$OUTPUT_PATH" | sed 's|^../../||')"
fi

# Create logs and output directories
mkdir -p "$PROJECT_ROOT/logs/lc_labels/$RUN_NAME" "$OUTPUT_PATH"

# If DIA_OBJECT_IDS is empty, process all available IDs using a single job
if [ ${#DIA_OBJECT_IDS[@]} -eq 0 ]; then
    echo "No specific diaObjectIds provided - will process all available IDs"
    
    # Create a single-job script to process all IDs
    TEMP_SCRIPT=$(mktemp)
    cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lc_labels_all
#SBATCH --output=$PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_all_%j.out
#SBATCH --error=$PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_all_%j.err
#SBATCH --time=24:00:00
#SBATCH --mem=8G
#SBATCH --cpus-per-task=2

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"

echo "Processing all diaObjectIds from dataset..."

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lc_labels visualization for all IDs
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lc_labels.py" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output-dir "\$OUTPUT_PATH"

exit_code=\$?
echo "Exit code: \$exit_code"
exit \$exit_code
EOF

    chmod +x "$TEMP_SCRIPT"
    
    # Submit single job
    SLURM_JOB_ID=$(sbatch --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT")
    
    echo "Submitted SLURM job: $SLURM_JOB_ID"
    echo ""
    echo "Monitor progress with:"
    echo "  squeue -u $USER"
    echo "  tail -f $PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_all_${SLURM_JOB_ID}.out"
    
    (sleep 60 && rm -f "$TEMP_SCRIPT") &
    exit 0
fi

# Otherwise process specific IDs as array job
echo "DiaObjectIds: ${DIA_OBJECT_IDS[@]}"

# Create a temporary script for the SLURM job
TEMP_SCRIPT=$(mktemp)

# Create comma-separated list of all IDs for navigation
ALL_IDS_STR=$(IFS=,; echo "${DIA_OBJECT_IDS[*]}")

cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lc_labels_viz
#SBATCH --output=$PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_%A_%a.out
#SBATCH --error=$PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_%A_%a.err
#SBATCH --time=01:00:00
#SBATCH --mem=4G
#SBATCH --cpus-per-task=1

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"
ALL_IDS="\$5"
shift 5
DIA_OBJECT_IDS=("\$@")

# Get the diaObjectId for this array task
DIA_OBJECT_ID=\${DIA_OBJECT_IDS[\$SLURM_ARRAY_TASK_ID]}

echo "Processing diaObjectId: \$DIA_OBJECT_ID"

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lc_labels visualization with navigation support
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lc_labels.py" \\
    "\$DIA_OBJECT_ID" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output "\$OUTPUT_PATH/lc_labels_\${DIA_OBJECT_ID}.html" \\
    --all-ids "\$ALL_IDS"

exit_code=\$?
echo "Exit code: \$exit_code for diaObjectId: \$DIA_OBJECT_ID"
exit \$exit_code
EOF

chmod +x "$TEMP_SCRIPT"

# Submit job array
NUM_IDS=${#DIA_OBJECT_IDS[@]}
SLURM_JOB_ID=$(sbatch --array=0-$((NUM_IDS-1)) --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT" "$ALL_IDS_STR" "${DIA_OBJECT_IDS[@]}")

echo "Submitted SLURM job array: $SLURM_JOB_ID"
echo "Array indices: 0-$((NUM_IDS-1))"
echo ""
echo "Monitor progress with:"
echo "  squeue -u $USER"
echo "  sacct -j $SLURM_JOB_ID"
echo ""
echo "Check logs in: $PROJECT_ROOT/logs/lc_labels/$RUN_NAME/lc_labels_${SLURM_JOB_ID}_*.{out,err}"

# Submit a follow-up job to create index after all lc_labels jobs complete
INDEX_SCRIPT=$(mktemp)
cat > "$INDEX_SCRIPT" << 'EOF'
#!/bin/bash
#SBATCH --job-name=lc_labels_index
#SBATCH --dependency=afterany:__JOB_ID__
#SBATCH --time=00:05:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task=1

OUTPUT_PATH="$1"
SCRIPT_DIR="$2"

sleep 10
python "$SCRIPT_DIR/create_lightcurve_index.py" "$OUTPUT_PATH"
EOF

sed -i "s/__JOB_ID__/$SLURM_JOB_ID/g" "$INDEX_SCRIPT"
chmod +x "$INDEX_SCRIPT"

INDEX_JOB_ID=$(sbatch --parsable "$INDEX_SCRIPT" "$OUTPUT_PATH" "$SCRIPT_DIR")

echo "Index creation job submitted: $INDEX_JOB_ID (will run after lc_labels jobs complete)"

(sleep 60 && rm -f "$TEMP_SCRIPT" "$INDEX_SCRIPT") &
