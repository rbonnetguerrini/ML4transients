#!/bin/bash
conda activate env_ML
# Configuration - Edit these parameters directly in the script
DATA_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/data/UDEEP_norm_high_conf_smallv5"
WEIGHTS_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/training/coteaching_optimized"
RUN_NAME="highconfSNN_transients"
OUTPUT_PATH="../../saved/lc/$RUN_NAME"

# List of diaObjectIds to process - Edit this list
DIA_OBJECT_IDS=(3496029161909165741
3496029161909182824
3496029161909200182
3495976385351016326
3495976385351016718
3495976385351021770
3495976385351021986
3495976385351024488
3495976385351027570
3495976385351030657
3495906016606835742
3495888424420859704
3495888424420865974
3495888424420868445
3495888424420878447
3495888424420908942
3495967589257999199
3495967589258003776
3495967589258005494
3495967589258013448
3495892822467312439
3495892822467315717
3495892822467318088
3495892822467320643
3495892822467326191
3495892822467332434
3495892822467336815
3495985181444044378
3495985181444046900
3495985181444047294
3495980783397533395
3495980783397533926
3495980783397537770
3495980783397541273
3495980783397541535
3495980783397542551
3495945599025437930
3495945599025457590
3495945599025474472
3496046754095202173
3496046754095204400
3496046754095208634
3496090734560307666
3496090734560311183
3496090734560314055
3496090734560314921
3496086336513789930
3496086336513795496
3496086336513796240
3496086336513796621
3496095132606819043
3496095132606819415
3496095132606822481
3495822453723132763
3495822453723139911
3495822453723148131
3495862036141726915
3495862036141731465
3495862036141731745
3495862036141734508
3495862036141738502
3495862036141739143
3495862036141739297
3495862036141742493
3495862036141744739
3495928006839403511
3495928006839404057
3495928006839409614
3495928006839410331
3495928006839411326
3496143511118441948
3495897220513804550
3496068744327744772
3496068744327762982
3496068744327765290
3496068744327768139
3496068744327769785
3496068744327779024
3496068744327781508
3496068744327785447
3495971987304511363
3495971987304526890
3495971987304528432
3495971987304539225
3495971987304542459
3495971987304549426
3495818055676618398
3495818055676619060
3495818055676624165
3496042356048675117
3496042356048707213
3496059948234704526
3496059948234717125
3496059948234727897
3496059948234728863
3496059948234741254
3496059948234745162
3495963191211494801
3495963191211497700
3495963191211497851
3495963191211507975
3495963191211508220
3495963191211518092
3496007171676587106
3496007171676599432
3496007171676605819
3496007171676607177
3496007171676607251
3496007171676616368
3496007171676619416
3496007171676622461
3495853240048702039
3495853240048702912
3495853240048704323
3495853240048704850
3495853240048707626
3495923608792950297
3495923608792957056
3495923608792962576
3495914812699902939
3495914812699909535
3495914812699909926
3495914812699912270
3495914812699915377
3495914812699920091
3495914812699926287
3496051152141696611
3496051152141706900
3496051152141710220
3496051152141714885
3496051152141714918
3496051152141715382
3496051152141716162
3496051152141716272
3496051152141732115
3495932404885911983
3495932404885914908
3495932404885915024
3495932404885917506
3496073142374290030
3496073142374300606
3496073142374310897
3495813657630093050
3495813657630108147
3495813657630109956
3495813657630116758
3496099530653323298
3496099530653323844
3496099530653324620
3496099530653325185
3496099530653325498
3496099530653326744
3495941200978929189
3495941200978933264
3495941200978940310
3495941200978940809
3496011569723113981
3496011569723114041
3496011569723114355
3496011569723114382
3496011569723119265
3496011569723122415
3495844443955675184
3495831249816151551
3495831249816154581
3495857638095211821
3495857638095216584
3495949997071956718
3495949997071958422
3495949997071960106
3495949997071960214
3495949997071963237
3495949997071972098
3495949997071972110
3495884026374292126
3495989579490550426
3495989579490554384
3495989579490554814
3495989579490559939
3495989579490561168
3495989579490564029
3495989579490565050
3495989579490566792
3496064346281236017
3496064346281236023
3496064346281240446
3496064346281244278
3496064346281248474
3496055550188241335
3496055550188253230
3496055550188254850
3496055550188274098
3495993977537062113
3495993977537091974
3495993977537098660
3495993977537103136
3496024763862630474
3496024763862650110
3496024763862650196
3496024763862652160
3496024763862652643
3495866434188243449
3495866434188253125
3495866434188256266
3495866434188263382
3495866434188264608
3495866434188265070
3495936802932404765
3495936802932405490
3495936802932415595
3495936802932419940
3495936802932420368
3496015967769625967
3496015967769630882
3496015967769632732
3496015967769634940
3496015967769639608
3496015967769639668
3495910414653351266
3495910414653355056
3495910414653356246
3495910414653356577
3495910414653366626
3496020365816133885
3496020365816137938
3496020365816150850
3495954395118467556
3495954395118467670
3495954395118494544
3495954395118508150
3495954395118512164
3495954395118525296
3496103928699848016
3496103928699856084
3496103928699856998
3496103928699858106
3496139113071924536
3496002773630097351
3496002773630100032
3496002773630105195
3496002773630106611
3496002773630107900
3495901618560343162
3495901618560344064
3495826851769657398
3495848842002204206
3496033559955696825
3496033559955704902
3496033559955705327
3496033559955712391
3496033559955712439
3496033559955739927
3495870832234760513
3495870832234780633
3495870832234780981
)

# Allow command line arguments to override the defaults
if [ $# -ge 3 ]; then
    DATA_PATH="$1"
    WEIGHTS_PATH="$2"
    OUTPUT_PATH="$3"
    shift 3
    if [ $# -gt 0 ]; then
        DIA_OBJECT_IDS=("$@")
    fi
fi

echo "Submitting lightcurve visualization batch job..."
echo "Data path: $DATA_PATH"
echo "Weights path: $WEIGHTS_PATH"
echo "Output path: $OUTPUT_PATH"
echo "DiaObjectIds: ${DIA_OBJECT_IDS[@]}"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Convert OUTPUT_PATH to absolute path if it's relative
if [[ "$OUTPUT_PATH" == ../* ]]; then
    OUTPUT_PATH="$PROJECT_ROOT/$(echo "$OUTPUT_PATH" | sed 's|^../../||')"
fi

# Create logs and output directories
mkdir -p "$PROJECT_ROOT/logs/lc/$RUN_NAME" "$OUTPUT_PATH"

# Create a temporary script for the SLURM job
TEMP_SCRIPT=$(mktemp)
cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lightcurve_viz
#SBATCH --output=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.out
#SBATCH --error=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.err
#SBATCH --time=01:00:00
#SBATCH --mem=4G
#SBATCH --cpus-per-task=1

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"
shift 4
DIA_OBJECT_IDS=("\$@")

# Get the diaObjectId for this array task
DIA_OBJECT_ID=\${DIA_OBJECT_IDS[\$SLURM_ARRAY_TASK_ID]}

echo "Processing diaObjectId: \$DIA_OBJECT_ID"

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lightcurve visualization
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lightcurve_visualization.py" \\
    "\$DIA_OBJECT_ID" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output "\$OUTPUT_PATH/lightcurve_\${DIA_OBJECT_ID}.html"

exit_code=\$?
echo "Exit code: \$exit_code for diaObjectId: \$DIA_OBJECT_ID"
exit \$exit_code
EOF

chmod +x "$TEMP_SCRIPT"

# Submit job array
NUM_IDS=${#DIA_OBJECT_IDS[@]}
SLURM_JOB_ID=$(sbatch --array=0-$((NUM_IDS-1)) --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT" "${DIA_OBJECT_IDS[@]}")

echo "Submitted SLURM job array: $SLURM_JOB_ID"
echo "Array indices: 0-$((NUM_IDS-1))"
echo ""
echo "Monitor progress with:"
echo "  squeue -u $USER"
echo "  sacct -j $SLURM_JOB_ID"
echo ""
echo "Check logs in: $PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_${SLURM_JOB_ID}_*.{out,err}"

# Submit a follow-up job to create index after all lightcurve jobs complete
INDEX_SCRIPT=$(mktemp)
cat > "$INDEX_SCRIPT" << 'EOF'
#!/bin/bash
#SBATCH --job-name=lightcurve_index
#SBATCH --dependency=afterany:__JOB_ID__
#SBATCH --time=00:05:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task=1

OUTPUT_PATH="$1"
SCRIPT_DIR="$2"

sleep 10
python "$SCRIPT_DIR/create_lightcurve_index.py" "$OUTPUT_PATH"
EOF

sed -i "s/__JOB_ID__/$SLURM_JOB_ID/g" "$INDEX_SCRIPT"
chmod +x "$INDEX_SCRIPT"

INDEX_JOB_ID=$(sbatch --parsable "$INDEX_SCRIPT" "$OUTPUT_PATH" "$SCRIPT_DIR")

echo "Index creation job submitted: $INDEX_JOB_ID (will run after lightcurve jobs complete)"

(sleep 60 && rm -f "$TEMP_SCRIPT" "$INDEX_SCRIPT") &