#!/bin/bash
conda activate env_ML
# Configuration - Edit these parameters directly in the script
DATA_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/data/UDEEP_norm_high_conf_smallv6"
WEIGHTS_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/training/coteaching_optimized"
RUN_NAME="highconfSNN_transientsv6"
OUTPUT_PATH="../../saved/lc/$RUN_NAME"

# List of diaObjectIds to process - Edit this list
DIA_OBJECT_IDS=(3496029161909165741
3496029161909182824
3496029161909200182
3495976385351016718
3495888424420859704
3495967589257999199
3495967589258003776
3495967589258005494
3495892822467315717
3495892822467318088
3495985181444044378
3495985181444047294
3495980783397533926
3495980783397541535
3495945599025474472
3496046754095202173
3496086336513789930
3496086336513796240
3496086336513796621
3496095132606819415
3496095132606822275
3495862036141704911
3495862036141735228
3495862036141739297
3495862036141742493
3495862036141744739
3496068744327735859
3495971987304511363
3495971987304526890
3495971987304539225
3496059948234727897
3496059948234730075
3495963191211497851
3496007171676605819
3496007171676607177
3496007171676607251
3496007171676616368
3496007171676622461
3495853240048704323
3495853240048704850
3495853240048707626
3495914812699862335
3495914812699912270
3496051152141706900
3496051152141714885
3496051152141715382
3496051152141716162
3496051152141732115
3496073142374300606
3495813657630093050
3496099530653305638
3496099530653325498
3495941200978915492
3495941200978929189
3495941200978940809
3496011569723113981
3496011569723114382
3495857638095211821
3495949997071929073
3495949997071956718
3495949997071963237
3495949997071972098
3495989579490550426
3495989579490554384
3495989579490564029
3495989579490566792
3496064346281236017
3496055550188214622
3496055550188274098
3495993977537091974
3496024763862650196
3496024763862652160
3496024763862652643
3496024763862652674
3495866434188265070
3495936802932415595
3496015967769625967
3496015967769630882
3495954395118494544
3495954395118512164
3496103928699856084
3496139113071924536
3496002773630105195
3495848842002204206
3495848842002207424
3496033559955712391
3496033559955712439
3496033559955739927
3495870832234753880
3495870832234780981
)

# Allow command line arguments to override the defaults
if [ $# -ge 3 ]; then
    DATA_PATH="$1"
    WEIGHTS_PATH="$2"
    OUTPUT_PATH="$3"
    shift 3
    if [ $# -gt 0 ]; then
        DIA_OBJECT_IDS=("$@")
    fi
fi

echo "Submitting lightcurve visualization batch job..."
echo "Data path: $DATA_PATH"
echo "Weights path: $WEIGHTS_PATH"
echo "Output path: $OUTPUT_PATH"
echo "DiaObjectIds: ${DIA_OBJECT_IDS[@]}"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Convert OUTPUT_PATH to absolute path if it's relative
if [[ "$OUTPUT_PATH" == ../* ]]; then
    OUTPUT_PATH="$PROJECT_ROOT/$(echo "$OUTPUT_PATH" | sed 's|^../../||')"
fi

# Create logs and output directories
mkdir -p "$PROJECT_ROOT/logs/lc/$RUN_NAME" "$OUTPUT_PATH"

# Create a temporary script for the SLURM job
TEMP_SCRIPT=$(mktemp)
cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lightcurve_viz
#SBATCH --output=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.out
#SBATCH --error=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.err
#SBATCH --time=01:00:00
#SBATCH --mem=4G
#SBATCH --cpus-per-task=1

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"
shift 4
DIA_OBJECT_IDS=("\$@")

# Get the diaObjectId for this array task
DIA_OBJECT_ID=\${DIA_OBJECT_IDS[\$SLURM_ARRAY_TASK_ID]}

echo "Processing diaObjectId: \$DIA_OBJECT_ID"

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lightcurve visualization
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lightcurve_visualization.py" \\
    "\$DIA_OBJECT_ID" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output "\$OUTPUT_PATH/lightcurve_\${DIA_OBJECT_ID}.html"

exit_code=\$?
echo "Exit code: \$exit_code for diaObjectId: \$DIA_OBJECT_ID"
exit \$exit_code
EOF

chmod +x "$TEMP_SCRIPT"

# Submit job array
NUM_IDS=${#DIA_OBJECT_IDS[@]}
SLURM_JOB_ID=$(sbatch --array=0-$((NUM_IDS-1)) --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT" "${DIA_OBJECT_IDS[@]}")

echo "Submitted SLURM job array: $SLURM_JOB_ID"
echo "Array indices: 0-$((NUM_IDS-1))"
echo ""
echo "Monitor progress with:"
echo "  squeue -u $USER"
echo "  sacct -j $SLURM_JOB_ID"
echo ""
echo "Check logs in: $PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_${SLURM_JOB_ID}_*.{out,err}"

# Submit a follow-up job to create index after all lightcurve jobs complete
INDEX_SCRIPT=$(mktemp)
cat > "$INDEX_SCRIPT" << 'EOF'
#!/bin/bash
#SBATCH --job-name=lightcurve_index
#SBATCH --dependency=afterany:__JOB_ID__
#SBATCH --time=00:05:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task=1

OUTPUT_PATH="$1"
SCRIPT_DIR="$2"

sleep 10
python "$SCRIPT_DIR/create_lightcurve_index.py" "$OUTPUT_PATH"
EOF

sed -i "s/__JOB_ID__/$SLURM_JOB_ID/g" "$INDEX_SCRIPT"
chmod +x "$INDEX_SCRIPT"

INDEX_JOB_ID=$(sbatch --parsable "$INDEX_SCRIPT" "$OUTPUT_PATH" "$SCRIPT_DIR")

echo "Index creation job submitted: $INDEX_JOB_ID (will run after lightcurve jobs complete)"

(sleep 60 && rm -f "$TEMP_SCRIPT" "$INDEX_SCRIPT") &