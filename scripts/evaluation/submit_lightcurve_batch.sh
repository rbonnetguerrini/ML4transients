#!/bin/bash
conda activate env_ML
# Configuration - Edit these parameters directly in the script
DATA_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/data/UDEEP_norm_high_conf_smallv5"
WEIGHTS_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/training/coteaching_optimized"
RUN_NAME="highconfSNN_gaia_stars"
OUTPUT_PATH="../../saved/lc/$RUN_NAME"

# List of diaObjectIds to process - Edit this list
DIA_OBJECT_IDS=(
3495976385351019030
3495906016606835778
3495906016606838787
3495906016606839883
3495906016606843127
3495888424420857919
3495888424420867657
3495888424420887788
3495967589258005654
3495967589258009422
3495967589258016524
3495892822467320562
3496112724792855090
3496112724792857537
3495985181444042443
3495985181444044505
3495985181444047538
3495945599025463841
3496046754095203202
3496090734560319202
3496090734560320819
3496086336513793850
3496086336513797153
3496095132606818918
3496095132606821418
3496095132606825171
3496095132606827313
3495862036141715830
3495862036141729733
3496143511118432745
3496143511118433352
3495897220513822327
3495897220513822626
3496068744327781295
3495971987304537630
3495971987304543597
3495818055676621387
3495963191211497507
3496007171676610077
3495853240048708674
3495923608792933337
3495923608792938831
3496051152141716619
3496051152141716680
3495932404885913083
3496073142374291183
3496073142374298112
3495813657630113244
3496099530653326026
3496134715025406388
3496134715025407129
3496011569723119180
3496108326746372470
3495857638095214736
3495949997071964527
3495949997071964576
3495949997071971839
3495949997071973741
3495989579490556554
3495989579490557619
3496064346281238131
3496064346281240533
3496064346281241708
3496055550188256373
3495993977537057557
3496024763862659593
3495866434188254382
3495866434188255496
3495936802932418145
3495936802932422312
3495936802932422478
3496015967769632165
3496015967769640302
3496020365816150213
3496020365816152359
3495954395118510882
3496103928699850834
3496103928699851537
3496103928699852685
3496103928699854690
3496103928699855320
3496139113071916484
3496139113071918483
3496002773630095546
3496002773630107335
3495901618560353722
3495848842002209632
3496033559955727200
3496033559955727832
3496033559955728167
3496033559955737218
)

# Allow command line arguments to override the defaults
if [ $# -ge 3 ]; then
    DATA_PATH="$1"
    WEIGHTS_PATH="$2"
    OUTPUT_PATH="$3"
    shift 3
    if [ $# -gt 0 ]; then
        DIA_OBJECT_IDS=("$@")
    fi
fi

echo "Submitting lightcurve visualization batch job..."
echo "Data path: $DATA_PATH"
echo "Weights path: $WEIGHTS_PATH"
echo "Output path: $OUTPUT_PATH"
echo "DiaObjectIds: ${DIA_OBJECT_IDS[@]}"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Convert OUTPUT_PATH to absolute path if it's relative
if [[ "$OUTPUT_PATH" == ../* ]]; then
    OUTPUT_PATH="$PROJECT_ROOT/$(echo "$OUTPUT_PATH" | sed 's|^../../||')"
fi

# Create logs and output directories
mkdir -p "$PROJECT_ROOT/logs/lc/$RUN_NAME" "$OUTPUT_PATH"

# Create a temporary script for the SLURM job
TEMP_SCRIPT=$(mktemp)
cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lightcurve_viz
#SBATCH --output=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.out
#SBATCH --error=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.err
#SBATCH --time=01:00:00
#SBATCH --mem=4G
#SBATCH --cpus-per-task=1

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"
shift 4
DIA_OBJECT_IDS=("\$@")

# Get the diaObjectId for this array task
DIA_OBJECT_ID=\${DIA_OBJECT_IDS[\$SLURM_ARRAY_TASK_ID]}

echo "Processing diaObjectId: \$DIA_OBJECT_ID"

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lightcurve visualization
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lightcurve_visualization.py" \\
    "\$DIA_OBJECT_ID" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output "\$OUTPUT_PATH/lightcurve_\${DIA_OBJECT_ID}.html"

exit_code=\$?
echo "Exit code: \$exit_code for diaObjectId: \$DIA_OBJECT_ID"
exit \$exit_code
EOF

chmod +x "$TEMP_SCRIPT"

# Submit job array
NUM_IDS=${#DIA_OBJECT_IDS[@]}
SLURM_JOB_ID=$(sbatch --array=0-$((NUM_IDS-1)) --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT" "${DIA_OBJECT_IDS[@]}")

echo "Submitted SLURM job array: $SLURM_JOB_ID"
echo "Array indices: 0-$((NUM_IDS-1))"
echo ""
echo "Monitor progress with:"
echo "  squeue -u $USER"
echo "  sacct -j $SLURM_JOB_ID"
echo ""
echo "Check logs in: $PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_${SLURM_JOB_ID}_*.{out,err}"

# Submit a follow-up job to create index after all lightcurve jobs complete
INDEX_SCRIPT=$(mktemp)
cat > "$INDEX_SCRIPT" << 'EOF'
#!/bin/bash
#SBATCH --job-name=lightcurve_index
#SBATCH --dependency=afterany:__JOB_ID__
#SBATCH --time=00:05:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task=1

OUTPUT_PATH="$1"
SCRIPT_DIR="$2"

sleep 10
python "$SCRIPT_DIR/create_lightcurve_index.py" "$OUTPUT_PATH"
EOF

sed -i "s/__JOB_ID__/$SLURM_JOB_ID/g" "$INDEX_SCRIPT"
chmod +x "$INDEX_SCRIPT"

INDEX_JOB_ID=$(sbatch --parsable "$INDEX_SCRIPT" "$OUTPUT_PATH" "$SCRIPT_DIR")

echo "Index creation job submitted: $INDEX_JOB_ID (will run after lightcurve jobs complete)"

(sleep 60 && rm -f "$TEMP_SCRIPT" "$INDEX_SCRIPT") &