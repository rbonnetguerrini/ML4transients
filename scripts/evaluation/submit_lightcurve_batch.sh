#!/bin/bash
conda activate env_ML
# Configuration - Edit these parameters directly in the script
DATA_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/data/UDEEP_norm_high_conf_smallv4"
WEIGHTS_PATH="/sps/lsst/groups/transients/HSC/fouchez/raphael/training/coteaching_optimized"
RUN_NAME="highconfv4_BW"
OUTPUT_PATH="../../saved/lc/$RUN_NAME"

# List of diaObjectIds to process - Edit this list
DIA_OBJECT_IDS=(
3496046754095217818
3495901618560353722
3495963191211497507
3495848842002204206
3496002773630105195
3496011569723114382
3495853240048707626
3496007171676607251
3495910414653359589
3496024763862652160
3496007171676607177
3495967589258005494
3496033559955712391
3495985181444047538
3495853240048704850
3496007171676616368
3495949997071971839
3495971987304539225
3495848842002209632
3496099530653305638
3495976385351016718
3496099530653325498
3496011569723113981
3495967589257999199
3496051152141716680
3495853240048704323
3495963191211497851
3495941200978940809
3496064346281240533
3496029161909182824
3496086336513796240
3495897220513822327
3495985181444047294
3495910414653355215
3496051152141716619
3495906016606839094
3496020365816150213
3495892822467318088
3495906016606838787
3495910414653356246
3495906016606839883
3495989579490564029
3496033559955739927
3495967589258005654
3496024763862652643
3495936802932415595
3495932404885913083
3495945599025479796
3496046754095204400
3496064346281241708
3496143511118432745
3496073142374300606
3495967589258016524
3495945599025474472
3495971987304511363
3495848842002207424
3495923608792950297
3495976385351021986
3495949997071972098
3496020365816150850
3495989579490550426
3495980783397541535
3496055550188254850
3495971987304526890
3496103928699856084
3495949997071929073
3496002773630106611
3495989579490557619
3496024763862659593
3495985181444044505
3495862036141742493
3495971987304543597
3496090734560307666
3496007171676605003
3496015967769625967
3495892822467320562
3496015967769630882
3495936802932425393
3495910414653356577
3495870832234780981
3496007171676622461
3495932404885920212
3496095132606822275
3496073142374290030
3495818055676618398
3496064346281242742
3496112724792855090
3496059948234728863
3496139113071918483
3495976385351021770
3496064346281238131
3496055550188253230
3495914812699926287
3496064346281236017
3495884026374265078
3495888424420898774
3495901618560325425
3495910414653354833
3496099530653323160
3496073142374291183
3495954395118508150
3496046754095203202
3496095132606819415
3495941200978933264
3495813657630116758
3496007171676619078
3495853240048702912
3496011569723119180
3495949997071956718
3495963191211496988
3495945599025463841
3496103928699858106
3496051152141716162
3496068744327744772
3495945599025437930
3495967589258013448
3495954395118467556
3495888424420859704
3496099530653322906
3495862036141729733
3496090734560314055
3495980783397542551
3496068744327769785
3495954395118512164
3496099530653326744
3495813657630113244
3496103928699852685
3495923608792962576
3495941200978906966
3496064346281240446
3496143511118441948
3495993977537091974
3495888424420865974
3496051152141710220
3495932404885915024
3496007171676587106
3496033559955712439
3496015967769640302
3496064346281236023
3496112724792857537
3495831249816151551
3496095132606825171
3496011569723114041
3496015967769632732
3496090734560314354
3496055550188256373
3495971987304542468
3496033559955737218
3495971987304539127
3495914812699909926
3495989579490561168
3496099530653323844
3496002773630100032
3495892822467320643
3496059948234717125
3495923608792947546
3495954395118467670
3495866434188253125
3495892822467310803
3496051152141721862
3496139113071913367
3495954395118525706
3496099530653323298
3495936802932404765
3495949997071963385
3495826851769646143
3495892822467336815
3495949997071967555
3495809259583580346
3496042356048675117
3495906016606835742
3496007171676603168
3495936802932422312
3495914812699902939
3496051152141714885
3496139113071924536
3495928006839411326
3495914812699909535
3496055550188241335
3496103928699850834
3495989579490565050
3495831249816154581
3495954395118469515
3495928006839409614
3496011569723122415
3496103928699855320
3496033559955709597
3496007171676610077
3495993977537081903
3495888424420878447
3495914812699906406
3495949997071963237
3495963191211508220
3496068744327781508
3495897220513822626
3495976385351016326
3495892822467332434
3495818055676621387
3495976385351019030
3495949997071973741
3496090734560306560
3495976385351019238
3495967589258003776
3496108326746371255
3495866434188255496
3496095132606827313
3495980783397537770
3496068744327785447
3495923608792933337
3496064346281244278
3495949997071960106
3495928006839409974
3495954395118510882
3495971987304562553
3496002773630098234
3496046754095211384
3496042356048707213
3495949997071930309
3495923608792922627
3496002773630107900
3495844443955675184
3496002773630097351
3496099530653325185
3496090734560319202
3496033559955705327
3495936802932418145
3495989579490554814
3496073142374298112
3495901618560344064
3495870832234780633
3496090734560320819
3496099530653325421
3495866434188254382
3495826851769657398
3496130316978894109
3495971987304528432
3496011569723114355
3496029161909199984
3495923608792948168
3495945599025457461
3496051152141696611
3495862036141731745
3495901618560337471
3496007171676619416
3495892822467326191
3496064346281248474
3496033559955704902
3495985181444042443
3495822453723139911
3496046754095204711
3496068744327765290
3495936802932420368
3495888424420908942
3496029161909200182
3496024763862630474
3496073142374290001
3495963191211497700
3495866434188258444
3496103928699854690
3496055550188214296
3495971987304549426
3496002773630107335
3495923608792938831
3496095132606822481
3495914812699920091
3495853240048702039
3496059948234726439
3495989579490555634
3495853240048708674
3495862036141735228
3496073142374310897
3496020365816137938
3496024763862652674
3496055550188274098
3495884026374271247
3496059948234741254
3496090734560283519
3496086336513793850
3495967589258009422
3495954395118525296
3495888424420867657
3495945599025457065
3495932404885911983
3496015967769629995
3495914812699905409
3495928006839410331
3496029161909218091
3495967589258014460
3496055550188233861
3495866434188250258
3496068744327776980
3495976385350994797
3495976385351006424
3495862036141734508
3496134715025407129
3496046754095217938
3496011569723115655
3495822453723132763
3495897220513804550
3496108326746372470
3496015967769632165
3496029161909199624
3496143511118433352
3496086336513793860
3496068744327762982
3495914812699912270
3496059948234745162
3495928006839386562
3496011569723121005
3496103928699849999
3495892822467315717
3495954395118527395
3495967589257979191
3495963191211518092
3496033559955696825
3495844443955670656
3496073142374295663
3496090734560314921
3495936802932405490
3496099530653326026
3495993977537062113
3495949997071962936
3496095132606820418
3496015967769632823
3495993977537098660
3495985181444044743
3495980783397541273
3495870832234753880
3496046754095202173
)

# Allow command line arguments to override the defaults
if [ $# -ge 3 ]; then
    DATA_PATH="$1"
    WEIGHTS_PATH="$2"
    OUTPUT_PATH="$3"
    shift 3
    if [ $# -gt 0 ]; then
        DIA_OBJECT_IDS=("$@")
    fi
fi

echo "Submitting lightcurve visualization batch job..."
echo "Data path: $DATA_PATH"
echo "Weights path: $WEIGHTS_PATH"
echo "Output path: $OUTPUT_PATH"
echo "DiaObjectIds: ${DIA_OBJECT_IDS[@]}"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Convert OUTPUT_PATH to absolute path if it's relative
if [[ "$OUTPUT_PATH" == ../* ]]; then
    OUTPUT_PATH="$PROJECT_ROOT/$(echo "$OUTPUT_PATH" | sed 's|^../../||')"
fi

# Create logs and output directories
mkdir -p "$PROJECT_ROOT/logs/lc/$RUN_NAME" "$OUTPUT_PATH"

# Create a temporary script for the SLURM job
TEMP_SCRIPT=$(mktemp)
cat > "$TEMP_SCRIPT" << EOF
#!/bin/bash
#SBATCH --job-name=lightcurve_viz
#SBATCH --output=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.out
#SBATCH --error=$PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_%A_%a.err
#SBATCH --time=01:00:00
#SBATCH --mem=4G
#SBATCH --cpus-per-task=1

DATA_PATH="\$1"
WEIGHTS_PATH="\$2"  
OUTPUT_PATH="\$3"
PROJECT_ROOT="\$4"
shift 4
DIA_OBJECT_IDS=("\$@")

# Get the diaObjectId for this array task
DIA_OBJECT_ID=\${DIA_OBJECT_IDS[\$SLURM_ARRAY_TASK_ID]}

echo "Processing diaObjectId: \$DIA_OBJECT_ID"

# Setup Python path
export PYTHONPATH="\$PROJECT_ROOT/src:\$PYTHONPATH"

# Run the lightcurve visualization
python "\$PROJECT_ROOT/src/ML4transients/evaluation/lightcurve_visualization.py" \\
    "\$DIA_OBJECT_ID" \\
    --data-path "\$DATA_PATH" \\
    --weights-path "\$WEIGHTS_PATH" \\
    --output "\$OUTPUT_PATH/lightcurve_\${DIA_OBJECT_ID}.html"

exit_code=\$?
echo "Exit code: \$exit_code for diaObjectId: \$DIA_OBJECT_ID"
exit \$exit_code
EOF

chmod +x "$TEMP_SCRIPT"

# Submit job array
NUM_IDS=${#DIA_OBJECT_IDS[@]}
SLURM_JOB_ID=$(sbatch --array=0-$((NUM_IDS-1)) --parsable "$TEMP_SCRIPT" "$DATA_PATH" "$WEIGHTS_PATH" "$OUTPUT_PATH" "$PROJECT_ROOT" "${DIA_OBJECT_IDS[@]}")

echo "Submitted SLURM job array: $SLURM_JOB_ID"
echo "Array indices: 0-$((NUM_IDS-1))"
echo ""
echo "Monitor progress with:"
echo "  squeue -u $USER"
echo "  sacct -j $SLURM_JOB_ID"
echo ""
echo "Check logs in: $PROJECT_ROOT/logs/lc/$RUN_NAME/lightcurve_${SLURM_JOB_ID}_*.{out,err}"

# Submit a follow-up job to create index after all lightcurve jobs complete
INDEX_SCRIPT=$(mktemp)
cat > "$INDEX_SCRIPT" << 'EOF'
#!/bin/bash
#SBATCH --job-name=lightcurve_index
#SBATCH --dependency=afterany:__JOB_ID__
#SBATCH --time=00:05:00
#SBATCH --mem=1G
#SBATCH --cpus-per-task=1

OUTPUT_PATH="$1"
SCRIPT_DIR="$2"

sleep 10
python "$SCRIPT_DIR/create_lightcurve_index.py" "$OUTPUT_PATH"
EOF

sed -i "s/__JOB_ID__/$SLURM_JOB_ID/g" "$INDEX_SCRIPT"
chmod +x "$INDEX_SCRIPT"

INDEX_JOB_ID=$(sbatch --parsable "$INDEX_SCRIPT" "$OUTPUT_PATH" "$SCRIPT_DIR")

echo "Index creation job submitted: $INDEX_JOB_ID (will run after lightcurve jobs complete)"

(sleep 60 && rm -f "$TEMP_SCRIPT" "$INDEX_SCRIPT") &